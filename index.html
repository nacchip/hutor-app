<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram WebApp — Registration</title>

  <!-- Telegram & Lottie -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <style>
    html, body {
      user-select: none
    }
    
    :root{
      --bg: #ffffff;
      --card-bg: #f8f9fa;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2f8de4;
      --accent-opaque: rgba(47,141,228,0.12);
      --button-text: #ffffff;
      --radius: 12px;
      --border: #e6e9ee;
    }

    .tg-dark{
      --bg:#0b0d0f;
      --card-bg:#141619;
      --text:#e6edf3;
      --muted:#9aa6b2;
      --accent:#2f9bf0;
      --accent-opaque: rgba(47,155,240,0.12);
      --button-text:#ffffff;
      --border:#222629;
    }

    /* ensure full page background applies */
    html,body{
      height:100%;
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* center app but keep full-page background visible */
    .root-wrap{
      min-height:100%;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding-top:28px;
    }

    .app {
      width:100%;
      max-width:420px;
      padding:18px;
    }

    .card {
      background:var(--card-bg);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow: 0 6px 18px rgba(2,6,23,0.04);
      padding:16px;
    }

    .scene { display:none; flex-direction:column; align-items:center; gap:12px; }
    .scene.active { display:flex; }

    .title { font-size:20px; font-weight:600; text-align:center; }

    .form { width:100%; display:flex; flex-direction:column; gap:10px; margin-top:6px; }
    .input {
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px;
      font-size:15px;
      background:transparent;
      color:var(--text);
    }

    .btn {
      width:100%;
      border:none;
      background:var(--accent);
      color:var(--button-text);
      padding:10px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      font-size:15px;
    }

    /* fixed Lottie sizes requested */
    .anim-100 { width:100px; height:100px; display:flex; justify-content:center; align-items:center; margin:6px auto 0; }

    /* Banks list */
    .bank-list { width:100%; display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .bank-item {
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      cursor:pointer;
      user-select:none;
      transition:background-color .12s, border-color .12s, transform .06s;
      background:transparent;
    }
    .bank-item:active { transform: translateY(1px); }

    .bank-item .lottie-small { width:24px; height:24px; flex:0 0 24px; display:flex; align-items:center; justify-content:center; }
    .bank-item .label { flex:1; font-size:15px; color:var(--text); }

    /* selected visual state */
    .bank-item.selected {
      border:2px solid var(--accent);
      background:var(--accent-opaque);
    }

    .placeholder {
      margin-top:10px;
      border-radius:8px;
      border:1px dashed var(--border);
      padding:18px;
      color:var(--muted);
      text-align:center;
      width:100%;
    }

    @media (max-width:420px){
      .app { padding:12px; }
    }
  </style>
</head>
<body>
  <div class="root-wrap">
    <div class="app">

      <!-- Scene 1 -->
      <div id="scene-1" class="scene active card">
        <div id="anim-register" class="anim-100" aria-hidden="true"></div>
        <div id="title-1" class="title">Регистрация</div>

        <div class="form">
          <input id="lastName" class="input" placeholder="Фамилия" />
          <input id="firstName" class="input" placeholder="Имя" />
          <select id="classSelect" class="input">
            <!-- placeholder option injected from JS -->
          </select>
          <button id="next1" class="btn">Далее</button>
        </div>
      </div>

      <!-- Scene 2 -->
      <div id="scene-2" class="scene card">
        <div id="anim-bank" class="anim-100" aria-hidden="true"></div>
        <div id="title-2" class="title">Пожалуйста, выберите банки, которыми вы пользуетесь</div>

        <div id="banksList" class="bank-list" role="list"></div>

        <button id="next2" class="btn">Далее</button>
      </div>

      <!-- Scene 3 -->
      <div id="scene-3" class="scene card">
        <div id="title-3" class="title">Сцена 3</div>
        <div id="placeholder" class="placeholder">Пока что пустая сцена (здесь можно добавить дальнейшие шаги)</div>
        <button id="sendData" class="btn">Отправить данные боту</button>
      </div>

    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp || null;
  try { tg?.expand(); } catch(e){}

  /* ===== Localization (added classLabel) ===== */
  const TRANSLATIONS = {
    ru: {
      title1: "Регистрация",
      lastName: "Фамилия",
      firstName: "Имя",
      classLabel: "Класс",
      next: "Далее",
      bankPrompt: "Пожалуйста, выберите банки, которыми вы пользуетесь",
      banks: [
        {file:"sber.json", label:"Сбербанк"},
        {file:"tbank.json", label:"Т-Банк"},
        {file:"alfa.json", label:"Альфа-Банк"},
        {file:"qiwi.json", label:"QIWI"},
        {file:"yoomoney.json", label:"ЮMoney"},
        {file:"sbp.json", label:"Другое (по СБП)"}
      ],
      scene3Title: "Сцена 3",
      scene3Placeholder: "Пока что пустая сцена (здесь можно добавить дальнейшие шаги)",
      sendData: "Отправить данные боту"
    },
    fr: {
      title1: "Inscription",
      lastName: "Nom de famille",
      firstName: "Prénom",
      classLabel: "Classe",
      next: "Suivant",
      bankPrompt: "Veuillez sélectionner les banques que vous utilisez",
      banks: [
        {file:"sber.json", label:"Sberbank"},
        {file:"tbank.json", label:"T-Bank"},
        {file:"alfa.json", label:"Alfa-Bank"},
        {file:"qiwi.json", label:"QIWI"},
        {file:"yoomoney.json", label:"YooMoney"},
        {file:"sbp.json", label:"Autre (via SBP)"}
      ],
      scene3Title: "Scène 3",
      scene3Placeholder: "Scène vide pour l'instant (vous pouvez ajouter les étapes suivantes ici)",
      sendData: "Envoyer les données au bot"
    },
    en: {
      title1: "Registration",
      lastName: "Last name",
      firstName: "First name",
      classLabel: "Class",
      next: "Next",
      bankPrompt: "Please select the banks you use",
      banks: [
        {file:"sber.json", label:"Sberbank"},
        {file:"tbank.json", label:"T-Bank"},
        {file:"alfa.json", label:"Alfa-Bank"},
        {file:"qiwi.json", label:"QIWI"},
        {file:"yoomoney.json", label:"YooMoney"},
        {file:"sbp.json", label:"Other (via SBP)"}
      ],
      scene3Title: "Scene 3",
      scene3Placeholder: "Empty scene for now (you can add further steps here)",
      sendData: "Send data to bot"
    }
  };

  function detectLang(){
    try {
      const code = tg?.initDataUnsafe?.user?.language_code || navigator.language || 'en';
      if (code.startsWith('ru')) return 'ru';
      if (code.startsWith('fr')) return 'fr';
      return 'en';
    } catch(e){
      return 'en';
    }
  }
  const LANG = detectLang();
  const L = TRANSLATIONS[LANG] || TRANSLATIONS.en;

  /* ===== Theme handling (use CSS variables so full page updates) ===== */
  function applyTheme(){
    // apply css class for dark/light to root element
    const scheme = tg?.colorScheme || 'light';
    if (scheme === 'dark') document.documentElement.classList.add('tg-dark');
    else document.documentElement.classList.remove('tg-dark');

    // apply themeParams to css variables when provided
    const p = tg?.themeParams || {};
    if (p.bg_color) document.documentElement.style.setProperty('--bg', p.bg_color);
    if (p.secondary_bg_color) document.documentElement.style.setProperty('--card-bg', p.secondary_bg_color);
    if (p.text_color) document.documentElement.style.setProperty('--text', p.text_color);
    if (p.hint_color) document.documentElement.style.setProperty('--muted', p.hint_color);
    if (p.button_color) document.documentElement.style.setProperty('--accent', p.button_color);
    if (p.button_text_color) document.documentElement.style.setProperty('--button-text', p.button_text_color);
    // compute accent-opaque for subtle selected background (fallback if CSS variable not set)
    const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#2f8de4';
    document.documentElement.style.setProperty('--accent-opaque', hexToRgba(accent, 0.12));
  }
  function hexToRgba(hex, a){
    try {
      hex = hex.replace('#','').trim();
      if (hex.length===3) hex = hex.split('').map(c=>c+c).join('');
      const r = parseInt(hex.slice(0,2),16);
      const g = parseInt(hex.slice(2,4),16);
      const b = parseInt(hex.slice(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    } catch(e){ return `rgba(47,141,228,${a})`; }
  }
  applyTheme();
  try { tg?.onEvent('themeChanged', applyTheme); } catch(e){}

  /* ===== Lottie loader (fixed-size behavior like example) ===== */
  function loadLottieFixed(container, path, opts = {}){
    // container: element or id
    const el = (typeof container === 'string') ? document.getElementById(container) : container;
    if(!el) return null;
    el.innerHTML = '';
    const animation = lottie.loadAnimation({
      container: el,
      renderer: 'svg',
      loop: opts.loop ?? false,
      autoplay: opts.autoplay ?? true,
      path: path
    });
    // restart on click (like your example)
    el.addEventListener('click', () => {
      try { animation.stop(); animation.play(); } catch(e){}
    });
    return animation;
  }

  /* ===== Populate UI texts and class select placeholder ===== */
  function populateTexts(){
    document.getElementById('title-1').textContent = L.title1;
    document.getElementById('title-2').textContent = L.bankPrompt;
    document.getElementById('title-3').textContent = L.scene3Title;
    document.getElementById('placeholder').textContent = L.scene3Placeholder;
    document.getElementById('next1').textContent = L.next;
    document.getElementById('next2').textContent = L.next;
    document.getElementById('sendData').textContent = L.sendData;
    document.getElementById('lastName').placeholder = L.lastName;
    document.getElementById('firstName').placeholder = L.firstName;

    // class select: first add translated placeholder (disabled)
    const sel = document.getElementById('classSelect');
    sel.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = `${L.classLabel} →`;
    placeholder.disabled = true;
    placeholder.selected = true;
    sel.appendChild(placeholder);

    const letters = ['А','Б','В'];
    for (let i=1;i<=11;i++){
      for (let ch of letters){
        const o = document.createElement('option');
        o.value = `${i}${ch}`;
        o.textContent = `${i}${ch}`;
        sel.appendChild(o);
      }
    }
  }

  /* ===== Scenes control ===== */
  function showScene(n){
    document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
    const el = document.getElementById('scene-' + n);
    if (el) el.classList.add('active');
  }

  /* ===== Banks list with selectable outline (toggle) ===== */
  function buildBanks(){
    const list = document.getElementById('banksList');
    list.innerHTML = '';
    L.banks.forEach((b, idx) => {
      const item = document.createElement('div');
      item.className = 'bank-item';
      item.setAttribute('role','button');
      item.setAttribute('data-bank', b.label);
      // small lottie holder
      const small = document.createElement('div');
      small.className = 'lottie-small';
      small.id = `bank-lottie-${idx}`;
      // label
      const span = document.createElement('div');
      span.className = 'label';
      span.textContent = b.label;

      item.appendChild(small);
      item.appendChild(span);
      list.appendChild(item);

      // load small lottie: keep fixed size, loop = false (like example)
      loadLottieFixed(small.id, b.file, { loop: false, autoplay: true });

      // toggle selection on click
      item.addEventListener('click', (e) => {
        // toggle selected class
        const sel = item.classList.contains('selected');
        if (sel) item.classList.remove('selected');
        else item.classList.add('selected');
      });
    });
  }

  /* ===== Collect data and send ===== */
  function collectData(){
    const banks = Array.from(document.querySelectorAll('.bank-item.selected')).map(it => it.getAttribute('data-bank'));
    return {
      lastName: document.getElementById('lastName').value || null,
      firstName: document.getElementById('firstName').value || null,
      class: document.getElementById('classSelect').value || null,
      banks,
      lang: LANG
    };
  }

  /* ===== Init on DOM ready ===== */
  document.addEventListener('DOMContentLoaded', () => {
    populateTexts();

    // load main lotties at fixed 100x100
    loadLottieFixed('anim-register', 'register.json', { loop: false, autoplay: true });
    loadLottieFixed('anim-bank', 'bank.json', { loop: false, autoplay: true });

    buildBanks();

    // buttons
    document.getElementById('next1').addEventListener('click', () => showScene(2));
    document.getElementById('next2').addEventListener('click', () => showScene(3));

    document.getElementById('sendData').addEventListener('click', () => {
      const payload = collectData();
      if (tg && typeof tg.sendData === 'function') {
        tg.sendData(JSON.stringify(payload));
      } else {
        // for testing outside Telegram
        alert(JSON.stringify(payload, null, 2));
      }
    });
  });
</script>
</body>
</html>
